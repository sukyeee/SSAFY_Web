
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>거래 조회</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    
    <link rel="stylesheet" href="<%=contextPath %>/css/style.css" type="text/css"></link>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow fixed-top">
        <div class="container">
          <a class="navbar-brand text-primary fw-bold" href="../index.jsp">
            구해줘 홈즈
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-lg-0">
            </ul>
            <!-- 로그인 전 -->
            
            <ul class="navbar-nav mb-2 me-2 mb-lg-0">
            <li class="nav-item">
                <a class="nav-link" aria-current="page" id="parking" href="<%=contextPath %>/jsp/map/mapParking.jsp">관심지역 주차장 정보</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" aria-current="page" id="logout" href="#">로그아웃</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" aria-current="page" id="myPage"href="<%=contextPath %>/user/userMain">마이페이지</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      
      
      <br>
      <br>
      <br>
     
    <div class="contianer">
        
        <!-- 거래정보 -->
        <div class="row" id="deal-content">
            <div id="deal-wrapper" class="col-3"></div>
            <div id="deal-wrapper" class="col">

                <div class="container"> 
                    <div class="row">
                        <h2 style="margin-top: 5px; margin-left: 0.5em;">이벤트</h2>
                        <hr>
                    </div>
                    <div id="deal-list" class="row deal-list">
                    	검색해주세요
                     
                    </div>
                </div>
            </div>        
            <div id="deal-wrapper" class="col-3"></div>
        </div>
            

        <!-- 상세정보 modal -->
  <div id="detail-modal" class="modal fade" id="detail-modal" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">상세정보</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div id="modal-body">
          ...
        </div>
        <div class="modal-footer">
            <i class="bi bi-suit-heart" id="interest"></i>
        </div>
      </div>
    </div>
  </div>

    </div>
    
<script type="text/javascript" src="<%=contextPath %>/js/util.js"></script>

<script>

/********************전역변수*********************/
let mapListArr;	// 거래내역 리스트






window.onload = function(){
	
	
}


function validateSearch(){
	let isGugunExist = false;
	let isDongExist = false;
	let isSearchInputExist = false;
	
	let gugunVal = document.querySelector("#gugun-select").value;
	let dongVal = document.querySelector("#dong-select").value;
	let searchVal = document.querySelector("#search-input").value;
	
	 if( gugunVal.length > 0 ){
		 isGugunExist = true;
     }
	 if( dongVal.length > 0 ){
		 isDongExist = true;
     }
	 if( searchVal.length > 0 ){
		 isSearchInputExist = true;
     }
	 
	 if((isGugunExist && isDongExist) ||(isGugunExist && isSearchInputExist))
		 return true;
	 
	 return false;
}

async function mapList(){
	let url = '<%= contextPath %>/map/mapList';
	
	let gugun_select = document.querySelector("#gugun-select");
	let gugunCode = (gugun_select.options[gugun_select.selectedIndex].value);
	
	//let gugunCode = (document.querySelector("#gugun-select").options[gugun-select.selectedIndex].value);
	let dong = document.querySelector("#dong-select").value;
	let searchWord = document.querySelector("#search-input").value;
	
	let urlParams = '?gugunCode=' + gugunCode + '&dong=' + dong + '&searchWord=' + searchWord;
	//let urlParams = `?limit=${LIST_ROW_COUNT}&offset=${OFFSET}`; // jsp el 표기법과 javascript es6 literal template 과 충돌
	let fetchOptions = {
		method: 'GET',
	}
	
	try{
		let response = await fetch( url + urlParams, fetchOptions);
		let data = await response.json();
		mapListArr = null;
		mapListArr = data;
		
		makeMapListHtml( data );
		
	}catch( error ){
		console.log(error);
		alert('거래내역 조회 과정에서 문제가 생겼습니다.')
	}
}

function makeMapListHtml(){
	let listHtml = ``;
	
	mapListArr.forEach( el => {

		let no = el.no;
		let AptName = el.AptName;
		let dealAmount = el.dealAmount;
		let dealDateStr = makeDateStr( el.dealYear, el.dealMonth, el.dealDay, '.');
		let area = el.area;
		
		listHtml += 
			`
		 <div class="row deal-list-item" data-dealNo="\${no}" data-bs-toggle="modal" data-bs-target="#detail-modal">
         <div class="row deal-name">\${AptName}</div>
         <div class="row deal-money">거래금액: \${dealAmount} <br>면적: \${area}</div>
         <div class="row deal-date">\${dealDateStr}</div>
     </div>
		`;
		
	});
	
	if(listHtml.length == 0)
		document.querySelector("#deal-list").innerHTML = "검색 결과가 없습니다";
	else {
		document.querySelector("#deal-list").innerHTML = listHtml;
		makeListHtmlEventHandler();
	}
	
	
}

function makeListHtmlEventHandler(){
	document.querySelectorAll("#deal-list > div").forEach( el => {
		el.onclick = function(){
			let no = this.getAttribute("data-dealNo");
			makeDetailHtml(no);
		}
	})
}


function makeDetailHtml(no){
	const item = mapListArr.find(el => el.no == no);	// mapListArr: 전역 변수 dealDto 리스트
		
	let gugun = item.gugun;
	let dong = item.dong;
	let jibun = item.jibun;
	
	
	let address = makeAddressStr(gugun, dong, jibun);
	let dealDate = makeDateStr(item.dealYear, item.dealMonth, item.dealDay, ".");
	
	document.querySelector('#modal-body').innerHTML = `건물명: \${item.AptName}<br>주소: \${address}<br>매매가: \${item.dealAmount}<br>거래일자: \${dealDate}<br>건축년도: \${item.buildYear}<br>층수: \${item.floor}<br>전용면적: \${item.area}`
	 
}

    		document.querySelector("#logout").onclick = function(){
    			logout();
    		}

		async function logout(){
        	let url = "<%= contextPath%>/logout";
        	
        	try{
                let response = await fetch( url ); 
                let data = await response.json(); 
                if( data.result == "fail"){ 
                  window.location.href = "<%= contextPath%>/jsp/login.jsp";
                }else if( data.result == "fail"){
              	  alert('로그아웃 과정에서 오류가 발생했습니다.');
                }            	
            }catch(error){
            	alert('로그아웃 과정에서 오류가 발생했습니다.');
            }
        }
		


</script>


</body>
</html>